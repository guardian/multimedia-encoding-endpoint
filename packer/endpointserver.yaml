builders:
  - type: amazon-ebs
    ami_name: Packer build for endpointserver 8
    #get a bit more compute, we are compiling stuff
    instance_type: t2.large
    source_ami: ami-c90195b0
    ssh_username: ec2-user
  - type: docker
    image: fedora:28  #keep this in sync with http://rpms.famillecollet.com/fedora/remi-release-28.rpm around line 51
    commit: true
#built 1st version at ami-7ca0cc05. need to check how to install memcached
#up-to-date ami at ami-f39af68a
provisioners:
  - type: file
    source: packer/files/nginx.conf
    destination: /tmp/nginx.conf

  - type: file
    source: packer/files/www.conf
    destination: /tmp/www.conf

  - type: shell
    inline:
      # needed for Docker build
      - if [ ! -x /usr/bin/sudo ]; then yum -y install sudo yum-utils ; fi
      #needed to ensure that awscli actually installs
      #https://bugzilla.redhat.com/show_bug.cgi?id=1417304
      - sudo yum-config-manager --enable rhui-REGION-rhel-server-optional
      - sudo yum -y update      - sudo yum -y install yum-utils policycoreutils nginx awscli
      - if [ ! -f /etc/fedora-release ]; then sudo rpm -ivh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm; fi

      - if [ ! -f /etc/fedora-release ]; then sudo yum -y install epel-release; fi
      # - sudo yum -y groupinstall 'Development Tools'
      # - sudo yum -y install bzip2 python-docutils nginx awscli mysql-devel libmemcached-devel memcached-devel libxml2-devel vim curl-devel openssl-devel mlocate curl libmcrypt libmcrypt-devel
      - sudo yum -y install yum-utils policycoreutils nginx awscli
      - sudo mv /tmp/nginx.conf /etc/nginx/nginx.conf

      #add in filebeat installation here. config will be done in userdata.
      - sudo rpm -Uvh https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.1.3-x86_64.rpm
      - sudo systemctl disable filebeat
      #FIXME: does it work on this version???
      #- curl http://ie1.php.net/distributions/php-7.2.2.tar.bz2 > php-7.2.2.tar.bz2
      #- tar xvjf php-7.2.2.tar.bz2
      #- cd php-7.2.2
      #- ./configure --with-mysql --with-zlib --with-mysqli=/usr/bin/mysql_config --with-openssl --with-curl --enable-dba --with-mcrypt --enable-ssl
      #- make -j2
      #- make test
      #- sudo make install
      #- cd ..
      #- rm -rf php-7.2.2*

      - if [ -f /etc/fedora-release ]; then sudo rpm -Uvh http://rpms.famillecollet.com/fedora/remi-release-28.rpm; else sudo rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-7.rpm; fi

      - echo ------------------------------------
      - echo Installing PHP
      - echo ------------------------------------

      - sudo yum -y --enablerepo=remi install php phpunit php-common php-mysql php-fpm php-pecl-memcache php-pecl-memcached
      - sudo mv /tmp/www.conf /etc/php-fpm.d/www.conf

      #- echo ------------------------------------
      #- echo Installing memcached extension
      #- echo ------------------------------------
      #- curl https://pecl.php.net/get/memcached-3.0.4.tgz > memcached-3.0.4.tgz
      #- tar xvzf memcached-3.0.4.tgz
      #- cd memcached-3.0.4
      #- phpize
      #- ./configure
      #- make -j2
      #- sudo make install
      #- cd ..
      #- rm -rf memcached-3.0.4
      #- echo ------------------------------------
      #- echo Setting up php setttings
      #- echo ------------------------------------

      #- sudo touch /usr/local/lib/php.ini
      #- sudo chown ec2-user /usr/local/lib/php.ini
      #- cat > /usr/local/lib/php.ini << EOF
      #- extension=memcached.so
      #- error_log=/var/log/php/error.log
      #- EOF
      #- sudo chown root /usr/local/lib/php.ini
      #install composer
      - sudo curl -s "http://getcomposer.org/installer" | php
      - echo Setting up selinux security context
      - sudo mkdir -p /var/www
      - if [ "`getenforce`" == "Enforcing" ]; then declare -x HAVE_SELINUX=1; else declare -x HAVE_SELINUX=0; fi
      - if [ "$HAVE_SELINUX" == "1" ]; then echo SELinux detected, setting up; else echo SELinux not detected, leaving; fi
      - if [ "$HAVE_SELINUX" == "1" ]; then sudo /usr/sbin/restorecon -R /var/www; fi
      - if [ "$HAVE_SELINUX" == "1" ]; then sudo setsebool -P httpd_can_network_connect 1; fi
      - echo Disabling nginx until configured by ASG
      #this will get re-enabled by the userdata
      - sudo systemctl disable nginx

      - echo Done
